---
title: "maftools : Summarize, Analyze and Visualize MAF Files"
author: "Anand Mayakonda"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    self_contained: yes
---
  

# Installation

```{r setup, include=FALSE}
library(maftools)
library(flexdashboard)
library(tidyverse)
library(ggplot2)
library(readr)
library(maps)
library(plotly)
library(mclust)
library(here)
```

```{r}
cohort_maf   <- maftools::merge_mafs(paste0(getwd(), "/" , "mafs/",  list.files("mafs/")))
maftools::inferHeterogeneity(cohort_maf)
```


## Mutational Signatures
Every cancer, as it progresses leaves a signature characterized by specific pattern of nucleotide substitutions. [Alexandrov et.al](http://www.nature.com/nature/journal/v500/n7463/full/nature12477.html) have shown such mutational signatures, derived from over 7000 cancer samples [Leiserson et al.,2015](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4531541/). Such signatures can be extracted by decomposing matrix of nucleotide substitutions, classified into 96 substitution classes based on immediate bases surrounding the mutated base. Extracted signatures can also be compared to those [validated signatures](http://cancer.sanger.ac.uk/cosmic/signatures).

First step in signature analysis is to obtain the adjacent bases surrounding the mutated base and form a mutation matrix.
NOTE: Earlier versions of maftools required a fasta file as an input. But starting from 1.8.0, BSgenome objects are used for faster sequence extraction.

```{r, eval=TRUE}
#Requires BSgenome object
library(BSgenome.Hsapiens.UCSC.hg19, quietly = TRUE)
trinucleotide_matrix = trinucleotideMatrix(maf        = cohort_maf,
                                           prefix     = '',
                                           add        = TRUE,
                                           ref_genome = "BSgenome.Hsapiens.UCSC.hg19")
```

trinucleotideMatrix {maftools}	R Documentation
Extract single 5' and 3' bases flanking the mutated site for de-novo signature analysis. Also estimates APOBEC enrichment scores.
Description
Extract single 5' and 3' bases flanking the mutated site for de-novo signature analysis. Also estimates APOBEC enrichment scores.

Usage
trinucleotideMatrix(maf, ref_genome = NULL, prefix = NULL, add = TRUE, ignoreChr = NULL, useSyn = TRUE, fn = NULL)

Arguments
maf
an MAF object generated by read.maf

ref_genome
BSgenome object or name of the installed BSgenome package. Example: BSgenome.Hsapiens.UCSC.hg19 Default NULL, tries to auto-detect from installed genomes.

prefix
Prefix to add or remove from contig names in MAF file.

add
If prefix is used, default is to add prefix to contig names in MAF file. If false prefix will be removed from contig names.

ignoreChr
Chromsomes to ignore from analysis. e.g. chrM

useSyn
Logical. Whether to include synonymous variants in analysis. Defaults to TRUE

fn
If given writes APOBEC results to an output file with basename fn. Default NULL.

Details
Extracts immediate 5' and 3' bases flanking the mutated site and classifies them into 96 substitution classes. Requires BSgenome data packages for sequence extraction.

APOBEC Enrichment: Enrichment score is calculated using the same method described by Roberts et al.

E = (n_tcw * background_c) / (n_C * background_tcw)

where, n_tcw = number of mutations within T[C>T]W and T[C>G]W context. (W -> A or T)

n_C = number of mutated C and G

background_C and background_tcw motifs are number of C and TCW motifs occuring around +/- 20bp of each mutation.

One-sided Fisher's Exact test is performed to determine the enrichment of APOBEC tcw mutations over background.

Value
list of 2. A matrix of dimension nx96, where n is the number of samples in the MAF and a table describing APOBEC enrichment per sample.

>References
Roberts SA, Lawrence MS, Klimczak LJ, et al. An APOBEC Cytidine Deaminase Mutagenesis Pattern is Widespread in Human Cancers. Nature genetics. 2013;45(9):970-976. doi:10.1038/ng.2702.


```{r}
head(trinucleotide_matrix$nmf_matrix)
```

```{r}
head(trinucleotide_matrix$APOBEC_scores)
```


Above function performs two steps:

  * Prepares a mutational matrix for signature analysis.
  * Estimates APOBEC enrichment scores

### APOBEC Enrichment estimation.
APOBEC induced mutations are more frequent in solid tumors and are mainly associated with C>T transition events occurring in TCW motif. APOBEC enrichment scores in the above command are estimated using the method described by [Roberts et al](https://www.nature.com/articles/ng.2702). Briefly, enrichment of C>T mutations occurring within TCW motif over all of the C>T mutations in a given sample is compared to background Cytosines and TCWs occurring within 20bp of mutated bases.


$$\frac{n_{tCw} * background_C}{n_C * background_{TCW}}$$

One-sided fishers exact test is also performed to statistically evaluate the enrichment score, as described in original study by Roberts et al.


### Differences between APOBEC enriched and non-enriched samples

We can also analyze the differences in mutational patterns between APOBEC enriched and non-APOBEC enriched samples. `plotApobecDiff` is a function which takes APOBEC enrichment scores estimated by `trinucleotideMatrix` and classifies samples into APOBEC enriched and non-APOBEC enriched. Once stratified, it compares these two groups to identify differentially altered genes.

```{r, eval=TRUE, fig.height=4, fig.width=7}
plotApobecDiff(tnm = trinucleotide_matrix,
               maf = cohort_maf,
               pVal = 0.2)
```


### Signature analysis
`extractSignatures` uses non-negative matrix factorization to decompose nx96 dimension matrix into r signatures, where n is the number of samples from input MAF [11](#references). By default function runs nmf on 6 ranks and chooses the best possible value based on maximum cophenetic-correlation coefficient. It is also possible to manually specify r. Once decomposed, signatures are compared against known signatures derived from [Alexandrov et.al](http://www.nature.com/nature/journal/v500/n7463/full/nature12477.html), and cosine similarity is calculated to identify best match.


```{r, fig.height=5, fig.width=5, eval=FALSE, message=FALSE}
#Run main function with maximum 6 signatures.
library('NMF')
mutsigs_nTry6 = extractSignatures(mat            = trinucleotide_matrix,
                                  nTry           = 6,
                                  plotBestFitRes = TRUE)
```